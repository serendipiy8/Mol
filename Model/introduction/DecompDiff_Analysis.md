# DecompDiff 数据划分和生成策略分析

## 📊 数据划分策略

### 1. **数据集划分方式**

DecompDiff使用**基于蛋白质名称的分割**策略，而不是简单的随机分割：

```python
# 从 split_pl_dataset.py 可以看到关键逻辑：
def get_pdb_name(fn):
    return os.path.basename(fn)[:4]  # 提取PDB ID的前4位

def get_unique_pockets(dataset, raw_id, used_pdb, num_pockets):
    # 确保测试集中的蛋白质在训练集中没有出现过
    for idx in tqdm(raw_id, 'Filter'):
        pdb_name = get_pdb_name(dataset[idx].ligand_filename)
        if pdb_name not in used_pdb and pdb_name not in pdb_visited:
            # 只选择训练集中未使用的PDB
```

### 2. **分割策略的核心原则**

- **训练集**: 包含约100,000个蛋白质-配体对
- **验证集**: 包含约1,000个蛋白质-配体对  
- **测试集**: 包含约20,000个蛋白质-配体对，但**只有100个不同的蛋白质**

**关键点**: 测试集确保使用**训练集中从未见过的蛋白质**！

### 3. **为什么这样划分？**

这是**结构基药物设计**的标准做法：
- 测试模型的**泛化能力**
- 验证模型能否为**新蛋白质**生成配体
- 避免**数据泄露**（同一蛋白质的配体既在训练集又在测试集）

## 🧬 生成策略

### 1. **生成目标**

从代码可以看出，DecompDiff的生成策略是：

```python
# 从 sample_diffusion_decomp.py:
def sample_diffusion_ligand_decomp(model, data, ...):
    # 为给定的蛋白质口袋生成配体分子
    # data 包含蛋白质口袋信息
    # 生成指定数量的配体样本
```

### 2. **生成过程**

1. **输入**: 蛋白质口袋结构（来自测试集）
2. **输出**: 多个配体分子候选
3. **生成数量**: 可配置（通常每个蛋白质生成多个候选）

### 3. **评估策略**

生成的分子会通过以下指标评估：
- **Vina Score**: 分子对接分数
- **QED**: 药物相似性
- **SA**: 合成可达性
- **Success Rate**: 成功生成率

## 🎯 回答你的具体问题

### Q1: 所有蛋白质-配体都作为训练集吗？

**答案**: 不是！

- **训练集**: 使用约100,000个蛋白质-配体对
- **测试集**: 使用约20,000个蛋白质-配体对，但**只包含100个不同的蛋白质**
- **关键**: 测试集的蛋白质在训练集中**从未出现过**

### Q2: 最后生成是哪些蛋白质的配体分子？

**答案**: 测试集中**从未见过的蛋白质**！

从配置可以看到：
```yaml
# configs/training.yml
split: ./data/split_by_name.pt  # 使用预定义的分割
```

这个分割确保：
- 训练时学习各种蛋白质-配体相互作用模式
- 测试时为新蛋白质生成配体（真正的泛化测试）

### Q3: 选几个还是所有的？

**答案**: 选择**特定的测试蛋白质**！

从代码逻辑看：
```python
# 测试集限制为100个不同的蛋白质
--test_num_pockets: 100
```

这样做的好处：
1. **计算效率**: 不需要为所有蛋白质生成
2. **评估标准**: 100个蛋白质足够评估模型性能
3. **公平比较**: 与其他方法使用相同的测试集

## 📈 实际数据分布

基于我们的分析结果：
- **总样本**: 99,265个
- **训练集**: 99,165个样本
- **测试集**: 100个样本（100个不同的蛋白质）

每个测试蛋白质通常有多个配体候选，所以实际测试时可能为每个蛋白质生成多个配体分子。

## 🔬 科学意义

这种划分策略体现了**结构基药物设计**的核心挑战：
1. **学习阶段**: 从已知蛋白质-配体相互作用中学习模式
2. **生成阶段**: 为新发现的蛋白质靶点设计配体
3. **评估阶段**: 验证生成分子的结合亲和力和药物性质

这正是DecompDiff论文的核心贡献：通过分解先验和扩散模型，为**新蛋白质**生成高质量的配体分子。
