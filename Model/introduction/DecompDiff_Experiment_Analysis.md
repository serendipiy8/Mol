# DecompDiff å®éªŒè®¾ç½®è¯¦ç»†åˆ†æ

## ğŸ§ª å®éªŒæµ‹è¯•å†…å®¹

### 1. **Jensen-Shannon Divergence (JSD) é”®é•¿åˆ†å¸ƒè¯„ä¼°**

#### **å®éªŒç›®çš„**
è¯„ä¼°ç”Ÿæˆåˆ†å­çš„é”®é•¿åˆ†å¸ƒæ˜¯å¦ä¸çœŸå®åˆ†å­ï¼ˆå‚è€ƒåˆ†å­ï¼‰çš„é”®é•¿åˆ†å¸ƒä¸€è‡´ã€‚

#### **å®éªŒè®¾ç½®**
```python
# ä» eval_bond_length.py å¯ä»¥çœ‹åˆ°ï¼š
def eval_bond_length_profile(bond_length_profile: BondLengthProfile) -> Dict[str, Optional[float]]:
    metrics = {}
    
    # Jensen-Shannon distances
    for bond_type, gt_distribution in eval_bond_length_config.EMPIRICAL_DISTRIBUTIONS.items():
        if bond_type not in bond_length_profile:
            metrics[f'JSD_{_bond_type_str(bond_type)}'] = None
        else:
            metrics[f'JSD_{_bond_type_str(bond_type)}'] = sci_spatial.distance.jensenshannon(
                gt_distribution, bond_length_profile[bond_type])
```

#### **è¯„ä¼°çš„é”®ç±»å‹**
- **C-C** (å•é”®ã€åŒé”®ã€èŠ³é¦™é”®)
- **C-N** (å•é”®ã€åŒé”®ã€èŠ³é¦™é”®)  
- **C-O** (å•é”®ã€åŒé”®)
- **C:C** (èŠ³é¦™é”®)
- **C:N** (èŠ³é¦™é”®)

#### **å®éªŒæµç¨‹**
1. **æ”¶é›†å‚è€ƒåˆ†å­é”®é•¿**: ä»è®­ç»ƒé›†ä¸­çš„çœŸå®åˆ†å­æå–å„ç§é”®ç±»å‹çš„é•¿åº¦åˆ†å¸ƒ
2. **æ”¶é›†ç”Ÿæˆåˆ†å­é”®é•¿**: ä»æ¨¡å‹ç”Ÿæˆçš„åˆ†å­æå–ç›¸åŒé”®ç±»å‹çš„é•¿åº¦åˆ†å¸ƒ
3. **è®¡ç®—JSD**: ä½¿ç”¨Jensen-Shannonæ•£åº¦æ¯”è¾ƒä¸¤ä¸ªåˆ†å¸ƒ
4. **JSDå€¼è¶Šå°**: è¡¨ç¤ºç”Ÿæˆåˆ†å­çš„é”®é•¿åˆ†å¸ƒè¶Šæ¥è¿‘çœŸå®åˆ†å­

### 2. **åˆ†å­æ€§è´¨æ¯”è¾ƒå®éªŒ**

#### **è¯„ä¼°æŒ‡æ ‡**
ä» `evaluate_mol_from_meta_full.py` å¯ä»¥çœ‹åˆ°ï¼š

```python
# åŒ–å­¦æ€§è´¨è¯„ä¼°
chem_results = scoring_func.get_chem(mol)

# å¯¹æ¥è¯„ä¼°
if args.docking_mode in ['vina_full', 'vina_score']:
    vina_results = {
        'score_only': score_only_results,
        'minimize': minimize_results,
        'dock': dock_results  # å¦‚æœä½¿ç”¨vina_fullæ¨¡å¼
    }
```

#### **å…·ä½“è¯„ä¼°æŒ‡æ ‡**

1. **QED (Quantitative Estimate of Drug-likeness)**
   - **ç›®çš„**: è¯„ä¼°åˆ†å­çš„è¯ç‰©ç›¸ä¼¼æ€§
   - **èŒƒå›´**: 0-1ï¼Œè¶Šé«˜è¶Šå¥½
   - **è®¡ç®—**: `np.mean(qed), np.median(qed)`

2. **SA (Synthetic Accessibility)**
   - **ç›®çš„**: è¯„ä¼°åˆ†å­çš„åˆæˆå¯è¾¾æ€§
   - **èŒƒå›´**: 1-10ï¼Œè¶Šä½è¶Šå¥½ï¼ˆè¶Šå®¹æ˜“åˆæˆï¼‰
   - **è®¡ç®—**: `np.mean(sa), np.median(sa)`

3. **Vina Score (åˆ†å­å¯¹æ¥åˆ†æ•°)**
   - **Vina Score**: å¿«é€Ÿå¯¹æ¥è¯„ä¼°
   - **Vina Min**: èƒ½é‡æœ€å°åŒ–åçš„å¯¹æ¥åˆ†æ•°
   - **Vina Dock**: å®Œæ•´å¯¹æ¥è¯„ä¼°
   - **èŒƒå›´**: è´Ÿå€¼ï¼Œè¶Šä½è¶Šå¥½ï¼ˆç»“åˆè¶Šå¼ºï¼‰

4. **High Affinity Rate**
   - **å®šä¹‰**: å¯¹æ¥åˆ†æ•° < -6.0 kcal/mol çš„åˆ†å­æ¯”ä¾‹
   - **æ„ä¹‰**: è¯„ä¼°ç”Ÿæˆé«˜è´¨é‡ç»“åˆåˆ†å­çš„èƒ½åŠ›

5. **Success Rate**
   - **å®šä¹‰**: æˆåŠŸç”Ÿæˆæœ‰æ•ˆåˆ†å­ç»“æ„çš„æ¯”ä¾‹
   - **æ„ä¹‰**: è¯„ä¼°æ¨¡å‹çš„ç”ŸæˆæˆåŠŸç‡

## ğŸ“Š å®éªŒæ•°æ®æ¥æº

### **å‚è€ƒåˆ†å­ï¼ˆGround Truthï¼‰**
```python
# ä»è®­ç»ƒé›†ä¸­æå–çš„é”®é•¿åˆ†å¸ƒä½œä¸ºå‚è€ƒ
EMPIRICAL_DISTRIBUTIONS = {
    (6, 6, 1): [...],  # C-Cå•é”®åˆ†å¸ƒ
    (6, 6, 2): [...],  # C-CåŒé”®åˆ†å¸ƒ
    (6, 6, 4): [...],  # C-CèŠ³é¦™é”®åˆ†å¸ƒ
    # ... å…¶ä»–é”®ç±»å‹
}
```

### **ç”Ÿæˆåˆ†å­**
```python
# ä»æ¨¡å‹ç”Ÿæˆç»“æœä¸­æå–
def bond_distance_from_mol(mol):
    # ä»ç”Ÿæˆçš„åˆ†å­çš„3Dç»“æ„ä¸­æå–é”®é•¿
    pos = mol.GetConformer().GetPositions()
    all_distances = []
    for bond in mol.GetBonds():
        # è®¡ç®—é”®é•¿å¹¶åˆ†ç±»
        distance = pdist[s_idx, e_idx]
        all_distances.append(((s_sym, e_sym, bond_type), distance))
    return all_distances
```

## ğŸ”¬ å®éªŒè®¾ç½®ç»†èŠ‚

### **æµ‹è¯•é›†é€‰æ‹©**
- **è›‹ç™½è´¨æ•°é‡**: 100ä¸ªä¸åŒçš„è›‹ç™½è´¨
- **æ¯ä¸ªè›‹ç™½è´¨**: ç”Ÿæˆå¤šä¸ªé…ä½“å€™é€‰
- **å…³é”®**: è¿™äº›è›‹ç™½è´¨åœ¨è®­ç»ƒé›†ä¸­ä»æœªè§è¿‡

### **ç”Ÿæˆè¿‡ç¨‹**
```python
# ä» sample_diffusion_decomp.py:
def sample_diffusion_ligand_decomp(model, data, ...):
    # ä¸ºç»™å®šè›‹ç™½è´¨å£è¢‹ç”Ÿæˆé…ä½“
    # ä½¿ç”¨æ‰©æ•£æ¨¡å‹é€æ­¥ç”Ÿæˆåˆ†å­ç»“æ„
    # åŒ…æ‹¬åŸå­ç±»å‹ã€ä½ç½®ã€é”®ç±»å‹
```

### **è¯„ä¼°æµç¨‹**
1. **ç”Ÿæˆé˜¶æ®µ**: ä¸ºæµ‹è¯•é›†è›‹ç™½è´¨ç”Ÿæˆé…ä½“åˆ†å­
2. **åŒ–å­¦éªŒè¯**: æ£€æŸ¥åˆ†å­æœ‰æ•ˆæ€§ï¼ˆSMILESè§£æã€3Dç»“æ„ï¼‰
3. **æ€§è´¨è®¡ç®—**: è®¡ç®—QEDã€SAç­‰åŒ–å­¦æ€§è´¨
4. **å¯¹æ¥è¯„ä¼°**: ä½¿ç”¨AutoDock Vinaè¿›è¡Œåˆ†å­å¯¹æ¥
5. **ç»Ÿè®¡åˆ†æ**: è®¡ç®—å„ç§æŒ‡æ ‡çš„å‡å€¼å’Œåˆ†ä½æ•°

## ğŸ“ˆ å®éªŒç»“æœè§£è¯»

### **JSDé”®é•¿åˆ†å¸ƒç»“æœ**
```
| Bond | liGAN | GraphBP | AR | Pocket2Mol | TargetDiff | Ours |
|------|-------|---------|----|------------|------------|------|
| C-C  | 0.601 | 0.368   | 0.609 | 0.496      | 0.369      | 0.359 |
| C-N  | 0.634 | 0.456   | 0.474 | 0.416      | 0.363      | 0.344 |
```

**è§£è¯»**: DecompDiffåœ¨C-Cå’ŒC-Né”®é•¿åˆ†å¸ƒä¸Šè¡¨ç°æœ€å¥½ï¼ˆJSDæœ€å°ï¼‰ï¼Œè¯´æ˜ç”Ÿæˆçš„åˆ†å­å…·æœ‰æ›´çœŸå®çš„åŒ–å­¦ç»“æ„ã€‚

### **ä¸»è¦è¯„ä¼°ç»“æœ**
```
| Methods    | Vina Score | Vina Min | Vina Dock | High Affinity | QED | SA | Success Rate |
|------------|------------|----------|-----------|---------------|-----|----|--------------|
| Reference  | -6.46      | -6.49    | -7.26     | -             | 0.47| 0.74| 25.0%        |
| DecompDiff | -6.04      | -7.09    | -8.43     | 71.0%         | 0.43| 0.60| 24.5%        |
```

**è§£è¯»**: 
- **Vina Min**: -7.09ï¼ˆæœ€å¥½ï¼‰ï¼Œè¯´æ˜ç”Ÿæˆçš„åˆ†å­ä¸è›‹ç™½è´¨ç»“åˆå¾ˆå¼º
- **High Affinity**: 71.0%ï¼ˆæœ€é«˜ï¼‰ï¼Œè¯´æ˜å¤§éƒ¨åˆ†ç”Ÿæˆåˆ†å­éƒ½æœ‰è‰¯å¥½çš„ç»“åˆäº²å’ŒåŠ›
- **Success Rate**: 24.5%ï¼Œæ¥è¿‘å‚è€ƒåˆ†å­ï¼Œè¯´æ˜ç”Ÿæˆè´¨é‡å¾ˆé«˜

## ğŸ¯ å®éªŒçš„ç§‘å­¦æ„ä¹‰

### **1. ç»“æ„çœŸå®æ€§éªŒè¯**
- JSDè¯„ä¼°ç¡®ä¿ç”Ÿæˆçš„åˆ†å­å…·æœ‰åŒ–å­¦ä¸Šåˆç†çš„é”®é•¿
- è¿™æ˜¯åˆ†å­ç”Ÿæˆçš„åŸºç¡€è¦æ±‚

### **2. è¯ç‰©æ€§è´¨è¯„ä¼°**
- QEDå’ŒSAè¯„ä¼°åˆ†å­çš„è¯ç‰©å¼€å‘æ½œåŠ›
- ç¡®ä¿ç”Ÿæˆçš„åˆ†å­å…·æœ‰å®é™…åº”ç”¨ä»·å€¼

### **3. ç”Ÿç‰©æ´»æ€§éªŒè¯**
- Vinaå¯¹æ¥åˆ†æ•°è¯„ä¼°åˆ†å­ä¸è›‹ç™½è´¨çš„ç»“åˆèƒ½åŠ›
- High Affinity Rateè¯„ä¼°ç”Ÿæˆé«˜è´¨é‡è¯ç‰©å€™é€‰çš„èƒ½åŠ›

### **4. æ³›åŒ–èƒ½åŠ›æµ‹è¯•**
- ä½¿ç”¨è®­ç»ƒé›†æœªè§è¿‡çš„è›‹ç™½è´¨è¿›è¡Œæµ‹è¯•
- éªŒè¯æ¨¡å‹å¯¹æ–°é¶ç‚¹çš„é…ä½“è®¾è®¡èƒ½åŠ›

## ğŸ” å®éªŒçš„åˆ›æ–°ç‚¹

1. **åˆ†è§£å…ˆéªŒ**: å°†åˆ†å­åˆ†è§£ä¸ºarmså’Œscaffoldsï¼Œæé«˜ç”Ÿæˆè´¨é‡
2. **ç»“æ„çº¦æŸ**: ä½¿ç”¨è›‹ç™½è´¨å£è¢‹çº¦æŸï¼Œç¡®ä¿ç”Ÿæˆçš„åˆ†å­èƒ½å¤Ÿç»“åˆ
3. **å¤šå°ºåº¦è¯„ä¼°**: ä»åŒ–å­¦ç»“æ„åˆ°ç”Ÿç‰©æ´»æ€§çš„å…¨æ–¹ä½è¯„ä¼°
4. **çœŸå®ä¸–ç•ŒéªŒè¯**: ä½¿ç”¨å®é™…è¯ç‰©å‘ç°ä¸­çš„è¯„ä¼°æ ‡å‡†

è¿™äº›å®éªŒè®¾ç½®ç¡®ä¿äº†DecompDiffä¸ä»…åœ¨ç†è®ºä¸Šå…ˆè¿›ï¼Œåœ¨å®é™…è¯ç‰©å‘ç°ä¸­ä¹Ÿæœ‰åº”ç”¨ä»·å€¼ã€‚
